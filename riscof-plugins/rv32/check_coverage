#!/bin/bash
set -e

# Create parent folder once
 mkdir -p all_riscof_works

# Run coverage for I extension
riscof coverage --config=config.ini --cgf-file ../../coverage/dataset.cgf \
  --cgf-file ../../coverage/i/rv32i.cgf \
  --suite ../../riscv-test-suite/rv32i_m/I \
  --env ../../riscv-test-suite/env \
  -h ../../coverage/header_file.yaml
 -d riscof_work ] && echo "riscof_work exists" || echo "riscof_work missing"
echo "Extracting RISCOF Coverage Summary..."
w3m -dump riscof_work/coverage.html > coverage.txt

# Print total coverpoints line
grep "Total Coverpoints" coverage.txt

# Print the heading for clarity
echo -e "\n        Coverage Label            (Covered)/(Total)    Percentage"

# Extract lines with coverage stats for each instruction (e.g., div, mul)
grep -E '^[[:space:]]*(add|addi|and|andi|auipc|beq|bge|bgeu|blt|bltu|bne|fence|jal|jalr|lb-align|lbu-align|lh-align|lhu-align|lui|lw-align|or|ori|sb-align|sh-align|sll|slli|slt|slti|sltiu|sltu|sra|srai|srl|srli|srai|sub|sw-align|xor|xori)[[:space:]]+[0-9]+/[0-9]+[[:space:]]+[0-9]+\.[0-9]+%' coverage.txt
echo "Moving riscof_work to all_riscof_works/riscof_work_I"
mv riscof_work all_riscof_works/riscof_work_I


# Run coverage for M extension
riscof coverage --config=config.ini --cgf-file ../../coverage/dataset.cgf \
  --cgf-file ../../coverage/m/rv32im.cgf \
  --suite ../../riscv-test-suite/rv32i_m/M \
  --env ../../riscv-test-suite/env \
  -h ../../coverage/header_file.yaml
[ -d riscof_work ] && echo "riscof_work exists" || echo "riscof_work missing"
w3m -dump riscof_work/coverage.html > coverage.txt
echo "Extracting RISCOF Coverage Summary..."

# Print total coverpoints line
grep "Total Coverpoints" coverage.txt

# Print the heading for clarity
echo -e "\n        Coverage Label            (Covered)/(Total)    Percentage"

# Extract lines with coverage stats for each instruction
grep -E '^[[:space:]]*(div|divu|mul|mulh|mulhsu|mulhu|rem|remu)[[:space:]]+[0-9]+/[0-9]+[[:space:]]+[0-9]+\.[0-9]+%' coverage.txt
echo "Moving riscof_work to all_riscof_works/riscof_work_M"
mv riscof_work all_riscof_works/riscof_work_M

# Run coverage for C extension
# riscof coverage --config=config.ini --cgf-file ../../coverage/dataset.cgf \
#   --cgf-file ../../coverage/c/rv32ic.cgf \
#   --suite ../../riscv-test-suite/rv32i_m/C \
#   --env ../../riscv-test-suite/env \
#   -h ../../coverage/header_file.yaml
# [ -d riscof_work ] && echo "riscof_work exists" || echo "riscof_work missing"
# w3m -dump riscof_work/coverage.html > coverage.txt
# echo "Extracting RISCOF Coverage Summary..."

# # Print total coverpoints line
# grep "Total Coverpoints" coverage.txt

# # Print the heading for clarity
# echo -e "\n        Coverage Label            (Covered)/(Total)    Percentage"

# # Extract lines with coverage stats for each instruction
# grep -E '^[[:space:]]*(c.addi4spn|c.lw|c.sw|c.nop|c.addi|c.jal|c.li|c.addi16sp|c.lui|c.srli|c.srai|c.andi|c.sub|c.xor|c.or|c.and|c.j|c.beqz|c.bnez|c.slli|c.mv|c.add|c.ebreak|c.jr|c.jalr|c.swsp|c.lwsp)[[:space:]]+[0-9]+/[0-9]+[[:space:]]+[0-9]+\.[0-9]+%' coverage.txt
# echo "Moving riscof_work to all_riscof_works/riscof_work_C"
# mv riscof_work all_riscof_works/riscof_work_C


